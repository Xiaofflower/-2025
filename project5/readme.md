
## **代码功能分析**


### **1. SM2 参数与椭圆曲线运算**

* **SM2 曲线参数**：

  * p, a, b：定义椭圆曲线方程 $y^2 = x^3 + ax + b \mod p$
  * Gx, Gy：基点坐标
  * n：曲线阶
* **点加运算** (point_add)：

  * 处理普通点加与倍点情况
  * 使用模逆运算完成斜率计算
* **标量乘运算** (scalar_mult)：

  * 实现点乘 k*G
  * 使用二进制加倍累加算法（Double-and-Add）


### **2. 私钥与公钥生成**

* **私钥 d**：随机整数 [1, n-1]
* **公钥 P**：通过标量乘 P = d * G生成

### **3. 消息哈希函数**

* 使用 SHA-256 对消息进行哈希：



### **4. SM2 签名与验签**

* **签名函数 sign**：

  * 输入消息 msg、私钥 d和可选的临时随机数k
  * 计算 r = (e + x1) % n 和 s = (k - r*d)/(1 + d) mod n
  * 返回 (r, s, k)
  * 支持外部指定 `k`，用于演示重复 k 漏洞 PoC
* **验签函数 verify**：

  * 计算 t = r + s mod n
  * 通过椭圆曲线点加和标量乘验证 `r == (e + x1) % n
  * 返回 True/False



### **5. 重复 k 漏洞 PoC**

* **目的**：演示如果两条消息使用相同临时随机数 k，私钥可能被恢复
* **方法**：

  1. 对两条消息强制使用相同 k签名
  2. 利用公式恢复临时k：

     $$
     k = (e_1 - e_2) * (s_1 - s_2)^{-1} \mod n
     $$
  3. 进一步恢复私钥：

     $$
     d = (s_1 k - e_1) * r^{-1} \mod n
     $$

### **6. 伪造签名 PoC**

* **目的**：演示如何构造一条“伪造”的签名 (r, s)，使其在公钥验证下通过
* **方法**：

  * 随机选择 r
  * 构造 s = (r * d^{-1} - e) % n
  * 验证函数会返回 True，表示签名可通过验证

### **7. 安全与优化说明**

* **优化方向**：

  * 使用 Jacobian 坐标优化点乘，减少模逆运算
  * 用 numba 或 cython 加速循环，提高原型效率
  * 支持批量验签优化
* **安全实验**：

  * 可验证重复 k 导致私钥泄露
  * 可演示伪造签名验证成功

